<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dompet Ceria - Pengelola Keuangan Keluarga</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ApexCharts CDN for animated charts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <!-- Google Fonts: Nunito -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons for a friendly icon set -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Custom CSS for family-friendly theme -->
    <style>
        :root {
            --bg-primary: #F7F9FC;
            --bg-secondary: #FFFFFF;
            --border-color: #E0E7FF;
            --accent-primary: #3B82F6;
            --accent-secondary: #10B981;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --shadow-color: rgba(59, 130, 246, 0.1);
        }

        body { font-family: 'Nunito', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); }
        .friendly-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1.5rem; box-shadow: 0 10px 25px -5px var(--shadow-color), 0 8px 10px -6px var(--shadow-color); transition: transform 0.2s ease-in-out; }
        .friendly-card:hover { transform: translateY(-4px); }
        .tab-btn.active { background-color: var(--accent-primary); color: white; font-weight: 700; box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.39); }
        .tab-btn:not(.active):hover { background-color: #EFF6FF; color: var(--accent-primary); }
        .btn-primary { background-color: var(--accent-primary); color: white; transition: all 0.3s ease; box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.39); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.45); }
        .btn-secondary { background-color: var(--accent-secondary); color: white; }
        .btn-danger { background-color: #EF4444; color: white; }
        .btn-outline { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-outline:hover { background-color: #F7F9FC; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background-color: var(--accent-primary); border-radius: 10px; border: 2px solid var(--bg-primary); }
        
        .toast-message { position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 100%); padding: 12px 24px; background-color: var(--accent-secondary); color: white; border-radius: 9999px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-weight: 600; opacity: 0; transition: all 0.4s ease-in-out; z-index: 100; }
        .toast-message.show { transform: translate(-50%, 0); opacity: 1; }
        
        .apexcharts-tooltip { background: #ffffff; border: 1px solid #e0e7ff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); border-radius: 8px; font-family: 'Nunito', sans-serif; }

        /* Edit Modal Styles */
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(17, 24, 39, 0.5); z-index: 40; transition: opacity 0.3s ease; }
        .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; transition: all 0.3s ease; }
    </style>
</head>
<body class="antialiased min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                <i class="ph-fill ph-house-line text-5xl text-blue-500"></i>
                <h1 class="text-3xl font-extrabold tracking-tight text-gray-800">Dompet<span class="text-blue-500">Ceria</span></h1>
            </div>
            <div id="dateTime" class="text-sm text-gray-500 bg-white px-4 py-2 rounded-full shadow-sm border border-gray-200"></div>
        </header>

        <main class="grid grid-cols-12 gap-6">
            <!-- Sidebar -->
            <aside class="col-span-12 lg:col-span-3">
                <div class="friendly-card p-6 space-y-4">
                    <h2 class="text-lg font-bold text-gray-600 mb-4">Menu Utama</h2>
                    <nav class="space-y-2">
                        <button onclick="showTab('dashboard')" class="tab-btn w-full flex items-center space-x-3 p-3 rounded-xl transition-all duration-300 active"><i class="ph ph-house text-xl"></i><span>Dasbor</span></button>
                        <button onclick="showTab('transactions')" class="tab-btn w-full flex items-center space-x-3 p-3 rounded-xl transition-all duration-300"><i class="ph ph-arrows-left-right text-xl"></i><span>Transaksi</span></button>
                        <button onclick="showTab('budget')" class="tab-btn w-full flex items-center space-x-3 p-3 rounded-xl transition-all duration-300"><i class="ph ph-target text-xl"></i><span>Anggaran</span></button>
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <section class="col-span-12 lg:col-span-9 space-y-6">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="friendly-card p-6"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-gray-600">Total Saldo</h3><i class="ph-fill ph-wallet text-3xl text-blue-400"></i></div><p id="totalBalance" class="text-3xl font-bold text-blue-500">Rp 0</p></div>
                        <div class="friendly-card p-6"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-gray-600">Total Pemasukan</h3><i class="ph-fill ph-arrow-circle-down text-3xl text-green-400"></i></div><p id="totalIncome" class="text-3xl font-bold text-green-500">Rp 0</p></div>
                        <div class="friendly-card p-6"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-gray-600">Total Pengeluaran</h3><i class="ph-fill ph-arrow-circle-up text-3xl text-red-400"></i></div><p id="totalExpense" class="text-3xl font-bold text-red-500">Rp 0</p></div>
                    </div>
                    <!-- Charts -->
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                        <div class="friendly-card p-6"><h3 class="font-semibold text-gray-600 mb-4">Ikhtisar Arus Kas</h3><div id="flowChart"></div></div>
                        <div class="friendly-card p-6"><h3 class="font-semibold text-gray-600 mb-4">Pengeluaran per Kategori</h3><div id="categoryChart"></div></div>
                    </div>
                     <!-- Recent Transactions (MODIFIED HTML) -->
                    <div class="friendly-card p-6">
                        <h3 class="font-semibold text-gray-600 mb-4">Transaksi Terakhir</h3>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b-2 border-gray-100"><th class="p-3 font-bold text-gray-500">Tanggal</th><th class="p-3 font-bold text-gray-500">Deskripsi</th><th class="p-3 font-bold text-gray-500">Kategori</th><th class="p-3 font-bold text-gray-500 text-right">Jumlah</th><th class="p-3 font-bold text-gray-500 text-center">Aksi</th></tr></thead><tbody id="recentTransactionsList"></tbody></table></div>
                    </div>
                </div>

                <!-- Transactions Tab -->
                <div id="transactions" class="tab-content hidden space-y-6">
                    <div class="friendly-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-blue-500">Tambah Transaksi Baru</h2>
                        <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div><label for="tr-type" class="block text-sm font-medium text-gray-500 mb-1">Tipe</label><select id="tr-type" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option></select></div>
                            <div><label for="tr-amount" class="block text-sm font-medium text-gray-500 mb-1">Jumlah (Rp)</label><input type="number" id="tr-amount" placeholder="50000" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></div>
                            <div class="md:col-span-2"><label for="tr-description" class="block text-sm font-medium text-gray-500 mb-1">Deskripsi</label><input type="text" id="tr-description" placeholder="Makan siang keluarga" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></div>
                            <div><label for="tr-category" class="block text-sm font-medium text-gray-500 mb-1">Kategori</label><select id="tr-category" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></select></div>
                            <div><label for="tr-date" class="block text-sm font-medium text-gray-500 mb-1">Tanggal</label><input type="date" id="tr-date" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></div>
                            <div class="md:col-span-2 text-right"><button type="submit" class="btn-primary font-bold py-2 px-6 rounded-lg">Simpan Transaksi</button></div>
                        </form>
                    </div>
                    <div class="friendly-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-blue-500">Riwayat Transaksi</h2>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b-2 border-gray-100"><th class="p-3 font-bold text-gray-500">Tanggal</th><th class="p-3 font-bold text-gray-500">Deskripsi</th><th class="p-3 font-bold text-gray-500">Kategori</th><th class="p-3 font-bold text-gray-500 text-right">Jumlah</th><th class="p-3 font-bold text-gray-500 text-center">Aksi</th></tr></thead><tbody id="fullTransactionsList"></tbody></table></div>
                    </div>
                </div>

                <!-- Budget Tab -->
                <div id="budget" class="tab-content hidden space-y-6">
                     <div class="friendly-card p-6"><h2 class="text-2xl font-bold mb-4 text-blue-500">Kelola Anggaran Bulanan</h2><div id="budgetList" class="space-y-6"></div></div>
                    <div class="friendly-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-blue-500">Tambah Anggaran Baru</h2>
                        <form id="addBudgetForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div class="md:col-span-2"><label for="new-budget-category" class="block text-sm font-medium text-gray-500 mb-1">Nama Kategori</label><input type="text" id="new-budget-category" placeholder="Contoh: Belanja Bulanan" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></div>
                            <div><label for="new-budget-amount" class="block text-sm font-medium text-gray-500 mb-1">Jumlah (Rp)</label><input type="number" id="new-budget-amount" placeholder="1000000" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></div>
                            <div class="md:col-span-3 text-right"><button type="submit" class="btn-primary font-bold py-2 px-6 rounded-lg"><i class="ph ph-plus-circle"></i> Tambah Anggaran</button></div>
                        </form>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- Toast Message Placeholder -->
        <div id="toastMessage" class="toast-message">Pesan</div>
    </div>

    <!-- MODAL UNTUK EDIT TRANSAKSI -->
    <div id="editTransactionModal" class="hidden">
        <div class="modal-backdrop" onclick="closeEditModal()"></div>
        <div class="modal-content w-full max-w-lg">
            <div class="friendly-card p-6 sm:p-8">
                <h2 class="text-2xl font-bold mb-6 text-blue-500">Edit Transaksi</h2>
                <form id="editTransactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="edit-tr-id">
                    <div><label for="edit-tr-type" class="block text-sm font-medium text-gray-500 mb-1">Tipe</label><select id="edit-tr-type" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option></select></div>
                    <div><label for="edit-tr-amount" class="block text-sm font-medium text-gray-500 mb-1">Jumlah (Rp)</label><input type="number" id="edit-tr-amount" placeholder="50000" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></div>
                    <div class="md:col-span-2"><label for="edit-tr-description" class="block text-sm font-medium text-gray-500 mb-1">Deskripsi</label><input type="text" id="edit-tr-description" placeholder="Makan siang keluarga" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></div>
                    <div><label for="edit-tr-category" class="block text-sm font-medium text-gray-500 mb-1">Kategori</label><select id="edit-tr-category" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></select></div>
                    <div><label for="edit-tr-date" class="block text-sm font-medium text-gray-500 mb-1">Tanggal</label><input type="date" id="edit-tr-date" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 transition"></div>
                    <div class="md:col-span-2 flex justify-end space-x-3 mt-4">
                        <button type="button" onclick="closeEditModal()" class="btn-outline font-bold py-2 px-6 rounded-lg">Batal</button>
                        <button type="submit" class="btn-primary font-bold py-2 px-6 rounded-lg">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    // --- State Management ---
    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    let budgets = JSON.parse(localStorage.getItem('budgets')) || [ { category: 'Makanan', allocated: 1500000, spent: 0 }, { category: 'Transportasi', allocated: 500000, spent: 0 }, { category: 'Tagihan', allocated: 1000000, spent: 0 }];

    // --- Chart instances ---
    let flowChartInstance = null;
    let categoryChartInstance = null;

    // --- Utility Functions ---
    const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    const formatDate = (dateString) => new Date(dateString).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
    
    // --- Toast Message ---
    function showToast(message) { const toast = document.getElementById('toastMessage'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }

    // --- UI Navigation ---
    function showTab(tabId) { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden')); document.getElementById(tabId).classList.remove('hidden'); document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active'); }

    // --- Core Logic ---
    function addTransaction(e) { e.preventDefault(); const type = document.getElementById('tr-type').value, amount = parseFloat(document.getElementById('tr-amount').value), description = document.getElementById('tr-description').value, category = document.getElementById('tr-category').value, date = document.getElementById('tr-date').value; if (!amount || !description || !date || !category) { alert('Harap isi semua kolom, termasuk memilih Kategori.'); return; } transactions.push({ id: Date.now(), type, amount, description, category, date }); document.getElementById('tr-amount').value = ''; document.getElementById('tr-description').value = ''; document.getElementById('tr-category').value = ''; document.getElementById('tr-date').valueAsDate = new Date(); saveAndRerender(); showToast('Transaksi berhasil ditambahkan!'); showTab('dashboard'); }
    function deleteTransaction(id) { if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) { transactions = transactions.filter(tr => tr.id !== id); saveAndRerender(); showToast('Transaksi berhasil dihapus.'); }}

    // --- Edit Transaction Modal Functions ---
    function openEditModal(id) {
        const transaction = transactions.find(tr => tr.id === id);
        if (!transaction) return;

        populateCategoryOptions(true); // Populate edit dropdown
        document.getElementById('edit-tr-id').value = transaction.id;
        document.getElementById('edit-tr-type').value = transaction.type;
        document.getElementById('edit-tr-amount').value = transaction.amount;
        document.getElementById('edit-tr-description').value = transaction.description;
        document.getElementById('edit-tr-category').value = transaction.category;
        document.getElementById('edit-tr-date').value = transaction.date;

        document.getElementById('editTransactionModal').classList.remove('hidden');
    }

    function closeEditModal() { document.getElementById('editTransactionModal').classList.add('hidden'); }

    function updateTransaction(e) {
        e.preventDefault();
        const id = parseInt(document.getElementById('edit-tr-id').value);
        const transactionIndex = transactions.findIndex(tr => tr.id === id);
        if (transactionIndex === -1) return;

        transactions[transactionIndex] = {
            id: id,
            type: document.getElementById('edit-tr-type').value,
            amount: parseFloat(document.getElementById('edit-tr-amount').value),
            description: document.getElementById('edit-tr-description').value,
            category: document.getElementById('edit-tr-category').value,
            date: document.getElementById('edit-tr-date').value
        };

        saveAndRerender();
        closeEditModal();
        showToast('Transaksi berhasil diperbarui!');
    }

    // --- Budget Logic ---
    function addBudget(e) { e.preventDefault(); const catInput = document.getElementById('new-budget-category'), amtInput = document.getElementById('new-budget-amount'), newCategory = catInput.value.trim(), newAmount = parseFloat(amtInput.value); if (!newCategory || !newAmount) { alert('Harap isi nama kategori dan jumlah anggaran.'); return; } if (budgets.some(b => b.category.toLowerCase() === newCategory.toLowerCase())) { alert('Kategori anggaran sudah ada.'); return; } budgets.push({ category: newCategory, allocated: newAmount, spent: 0 }); saveAndRerender(); catInput.value = ''; amtInput.value = ''; showToast('Anggaran baru berhasil ditambahkan!'); }
    function updateBudget(index) { const inputEl = document.getElementById(`budget-input-${index}`), newAmount = parseFloat(inputEl.value); if (isNaN(newAmount) || newAmount < 0) { alert('Harap masukkan jumlah yang valid.'); return; } budgets[index].allocated = newAmount; saveAndRerender(); showToast(`Anggaran "${budgets[index].category}" diperbarui.`); }
    function deleteBudget(index) { const catToDelete = budgets[index].category; if (confirm(`Apakah Anda yakin ingin menghapus anggaran untuk "${catToDelete}"?`)) { budgets.splice(index, 1); saveAndRerender(); showToast(`Anggaran "${catToDelete}" berhasil dihapus.`); } }

    // --- Rendering Functions ---
    function renderSummary() { const totalIncome = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0), totalExpense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0), totalBalance = totalIncome - totalExpense; document.getElementById('totalBalance').textContent = formatCurrency(totalBalance); document.getElementById('totalIncome').textContent = formatCurrency(totalIncome); document.getElementById('totalExpense').textContent = formatCurrency(totalExpense); }
    
    // MODIFIED renderRecentTransactions to include edit/delete buttons
    function renderRecentTransactions() {
        const list = document.getElementById('recentTransactionsList');
        list.innerHTML = '';
        const recent = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
        if (recent.length === 0) {
            list.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Belum ada transaksi.</td></tr>';
            return;
        }
        recent.forEach(tr => {
            const row = document.createElement('tr');
            row.className = `border-b border-gray-100 hover:bg-blue-50`;
            row.innerHTML = `
                <td class="p-3 text-gray-500">${formatDate(tr.date)}</td>
                <td class="p-3 font-semibold text-gray-700">${tr.description}</td>
                <td class="p-3 text-gray-500">${tr.category}</td>
                <td class="p-3 text-right font-bold ${tr.type === 'income' ? 'text-green-500' : 'text-red-500'}">${tr.type === 'income' ? '+' : '-'} ${formatCurrency(tr.amount)}</td>
                <td class="p-3 text-center space-x-2">
                    <button onclick="openEditModal(${tr.id})" class="text-blue-500 hover:text-blue-700 transition p-1 rounded-full hover:bg-blue-100 text-lg"><i class="ph ph-pencil-simple"></i></button>
                    <button onclick="deleteTransaction(${tr.id})" class="text-red-500 hover:text-red-700 transition p-1 rounded-full hover:bg-red-100 text-lg"><i class="ph ph-trash"></i></button>
                </td>
            `;
            list.appendChild(row);
        });
    }
    
    function renderAllTransactions() {
        const list = document.getElementById('fullTransactionsList'); list.innerHTML = '';
        const allSorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
        if (allSorted.length === 0) { list.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Belum ada transaksi.</td></tr>'; return; }
        allSorted.forEach(tr => { const row = document.createElement('tr'); row.className = `border-b border-gray-100 hover:bg-blue-50`; row.innerHTML = `<td class="p-3 text-gray-500">${formatDate(tr.date)}</td><td class="p-3 font-semibold text-gray-700">${tr.description}</td><td class="p-3 text-gray-500">${tr.category}</td><td class="p-3 text-right font-bold ${tr.type === 'income' ? 'text-green-500' : 'text-red-500'}">${tr.type === 'income' ? '+' : '-'} ${formatCurrency(tr.amount)}</td><td class="p-3 text-center space-x-2"><button onclick="openEditModal(${tr.id})" class="text-blue-500 hover:text-blue-700 transition p-1 rounded-full hover:bg-blue-100 text-lg"><i class="ph ph-pencil-simple"></i></button><button onclick="deleteTransaction(${tr.id})" class="text-red-500 hover:text-red-700 transition p-1 rounded-full hover:bg-red-100 text-lg"><i class="ph ph-trash"></i></button></td>`; list.appendChild(row); });
    }

    function renderBudgets() { budgets.forEach(b => { b.spent = transactions.filter(tr => tr.type === 'expense' && tr.category === b.category).reduce((s, tr) => s + tr.amount, 0); }); const budgetContainer = document.getElementById('budgetList'); budgetContainer.innerHTML = ''; if (budgets.length === 0) { budgetContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Anda belum memiliki anggaran.</p>'; return; } budgets.forEach((b, i) => { const p = b.allocated > 0 ? (b.spent / b.allocated) * 100 : 0; const c = p > 100 ? 'bg-red-500' : (p > 75 ? 'bg-yellow-400' : 'bg-blue-500'); const el = document.createElement('div'); el.className = 'p-4 border border-gray-200 rounded-xl'; el.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center"><div class="md:col-span-1"><h4 class="font-bold text-lg text-gray-800">${b.category}</h4><p class="text-sm text-gray-500">${formatCurrency(b.spent)} / <span class="font-semibold">${formatCurrency(b.allocated)}</span></p></div><div class="md:col-span-2"><div class="w-full bg-gray-200 rounded-full h-2.5 mb-2"><div class="${c} h-2.5 rounded-full" style="width: ${Math.min(p, 100)}%"></div></div><div class="flex items-center gap-2"><input type="number" id="budget-input-${i}" value="${b.allocated}" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 transition" placeholder="Ganti nominal"><button onclick="updateBudget(${i})" class="btn-secondary text-xs font-bold py-1.5 px-3 rounded-lg flex-shrink-0">Simpan</button><button onclick="deleteBudget(${i})" class="btn-danger text-xs font-bold py-1.5 px-3 rounded-lg flex-shrink-0"><i class="ph ph-trash"></i></button></div>${p > 100 ? `<p class="text-xs text-red-500 mt-1">Melebihi anggaran sebesar ${formatCurrency(b.spent - b.allocated)}!</p>` : ''}</div></div>`; budgetContainer.appendChild(el); }); }
    
    function populateCategoryOptions(isEdit = false) { const selectId = isEdit ? 'edit-tr-category' : 'tr-category'; const catSelect = document.getElementById(selectId); const currentValue = catSelect.value; catSelect.innerHTML = `<option value="" disabled ${isEdit ? '' : 'selected'}>Pilih Kategori</option>`; const defaultCats = ['Gaji', 'Bonus', 'Lainnya'], expenseCats = budgets.map(b => b.category), allCats = [...new Set([...expenseCats, ...defaultCats])]; allCats.forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; catSelect.appendChild(opt); }); if(isEdit) catSelect.value = currentValue; }
    
    function renderCharts() { const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des']; const incomeData = Array(12).fill(0); const expenseData = Array(12).fill(0); transactions.forEach(tr => { const month = new Date(tr.date).getMonth(); if (tr.type === 'income') incomeData[month] += tr.amount; else expenseData[month] += tr.amount; }); const expenseByCategory = transactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {}); const categoryLabels = Object.keys(expenseByCategory); const categoryData = Object.values(expenseByCategory); const friendlyColors = ['#60A5FA', '#34D399', '#FBBF24', '#F87171', '#A78BFA', '#22D3EE']; const flowOptions = { series: [{ name: 'Pemasukan', data: incomeData }, { name: 'Pengeluaran', data: expenseData }], chart: { type: 'bar', height: 300, fontFamily: 'Nunito, sans-serif', toolbar: { show: false } }, colors: ['#10B981', '#EF4444'], plotOptions: { bar: { horizontal: false, columnWidth: '55%', borderRadius: 8 } }, dataLabels: { enabled: false }, stroke: { show: true, width: 2, colors: ['transparent'] }, xaxis: { categories: labels, labels: { style: { colors: '#6B7280' } } }, yaxis: { labels: { style: { colors: '#6B7280' }, formatter: (val) => `Rp ${val/1000}k` } }, fill: { opacity: 1 }, legend: { position: 'top', horizontalAlign: 'right' }, tooltip: { y: { formatter: (val) => formatCurrency(val) } }, grid: { borderColor: '#F7F9FC' } }; if (flowChartInstance) { flowChartInstance.updateOptions(flowOptions); } else { flowChartInstance = new ApexCharts(document.querySelector("#flowChart"), flowOptions); flowChartInstance.render(); } const categoryOptions = { series: categoryData.length > 0 ? categoryData : [1], labels: categoryLabels.length > 0 ? categoryLabels : ['Tidak ada data'], colors: friendlyColors, chart: { type: 'donut', height: 300, fontFamily: 'Nunito, sans-serif' }, plotOptions: { pie: { donut: { labels: { show: true, total: { show: true, label: 'Total', color: '#1F2937', formatter: (w) => formatCurrency(w.globals.seriesTotals.reduce((a, b) => a + b, 0)) } } } } }, dataLabels: { enabled: false }, legend: { position: 'bottom' }, responsive: [{ breakpoint: 480, options: { chart: { width: 250 }, legend: { position: 'bottom' } } }] }; if (categoryChartInstance) { categoryChartInstance.updateOptions(categoryOptions); } else { categoryChartInstance = new ApexCharts(document.querySelector("#categoryChart"), categoryOptions); categoryChartInstance.render(); } }

    // --- Main App Function ---
    function saveAndRerender() { localStorage.setItem('transactions', JSON.stringify(transactions)); localStorage.setItem('budgets', JSON.stringify(budgets)); renderSummary(); renderRecentTransactions(); renderAllTransactions(); renderBudgets(); populateCategoryOptions(); populateCategoryOptions(true); renderCharts(); }

    // --- Event Listeners and Initial Load ---
    document.addEventListener('DOMContentLoaded', () => { document.getElementById('transactionForm').addEventListener('submit', addTransaction); document.getElementById('addBudgetForm').addEventListener('submit', addBudget); document.getElementById('editTransactionForm').addEventListener('submit', updateTransaction); document.getElementById('tr-date').valueAsDate = new Date(); updateDateTime(); setInterval(updateDateTime, 60000); saveAndRerender(); showTab('dashboard'); });
    function updateDateTime() { const now = new Date(); const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }; document.getElementById('dateTime').textContent = now.toLocaleDateString('id-ID', options); }
</script>
<script 
    src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  // Ganti sesuai project kamu
  const SUPABASE_URL = "https://njqjtlwijgddwuhirfcg.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qcWp0bHdpamdkZHd1aGlyZmNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMzQ4ODcsImV4cCI6MjA3NTkxMDg4N30.xlcrdqnWScYZU8QaiANBEWbl16Sm7PCKiyuiHNFeVCs";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>
</body>
</html>


